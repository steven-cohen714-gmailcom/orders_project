<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Maintenance - Universal Recycling</title>
  <link rel="stylesheet" href="/static/css/style.css" />
</head>
<body>

  {% include "_tab_nav.html" %}

  <h2>Maintenance</h2>

  <div class="tabs">
    <div class="tab active" data-tab="users">Users</div>
    <div class="tab" data-tab="requesters">Requesters</div>
    <div class="tab" data-tab="items">Items</div>
    <div class="tab" data-tab="projects">Projects</div>
    <div class="tab" data-tab="settings">Settings</div>
    <div class="tab" data-tab="business_details">Business Details</div>
  </div>

  <div id="users" class="tab-content active">
    <form class="form-group" onsubmit="event.preventDefault(); addUser();">
      <label for="user-username">Username:</label>
      <input type="text" id="user-username" autocomplete="username" />
      <label for="user-password">Password:</label>
      <input type="password" id="user-password" autocomplete="current-password" />
      <label for="user-rights">Rights:</label>
      <select id="user-rights">
        <option value="edit">Edit</option>
        <option value="view">View Only</option>
        <option value="admin">Admin</option>
      </select>
      <button type="submit">Add User</button>
    </form>
    <table>
      <thead>
        <tr><th>Username</th><th>Rights</th><th>Actions</th></tr>
      </thead>
      <tbody id="users-table"></tbody>
    </table>
  </div>

  <div id="requesters" class="tab-content">
    <div class="form-group">
      <label for="requester-name">Name:</label>
      <input type="text" id="requester-name" />
      <button onclick="addRequester()">Add Requester</button>
    </div>
    <table>
      <thead><tr><th>Name</th><th>Actions</th></tr></thead>
      <tbody id="requesters-table"></tbody>
    </table>
  </div>

  <div id="items" class="tab-content">
    <div class="form-group">
      <label for="item-code">Item Code:</label>
      <input type="text" id="item-code" />
      <label for="item-description">Description:</label>
      <input type="text" id="item-description" />
      <button onclick="addItem()">Add Item</button>
    </div>
    <table>
      <thead><tr><th>Item Code</th><th>Description</th><th>Actions</th></tr></thead>
      <tbody id="items-table"></tbody>
    </table>
  </div>

  <div id="projects" class="tab-content">
    <div class="form-group">
      <label for="project-code">Project Code:</label>
      <input type="text" id="project-code" />
      <label for="project-name">Project Name:</label>
      <input type="text" id="project-name" />
      <button onclick="addProject()">Add Project</button>
    </div>
    <table>
      <thead><tr><th>Project Code</th><th>Project Name</th><th>Actions</th></tr></thead>
      <tbody id="projects-table"></tbody>
    </table>
  </div>

  <div id="settings" class="tab-content">
    <div class="form-group">
      <label for="order-number-start">Start Order Number:</label>
      <input type="text" id="order-number-start" />
      <label for="auth-threshold">Authorization Threshold (R):</label>
      <input type="number" id="auth-threshold" step="0.01" />
      <button onclick="updateSettings()">Update</button>
    </div>
  </div>

  <div id="business_details" class="tab-content">
    <div class="form-group">
      <label for="company-name">Company Name:</label>
      <input type="text" id="company-name" />
      <label for="address-line1">Address Line 1:</label>
      <input type="text" id="address-line1" />
      <label for="address-line2">Address Line 2:</label>
      <input type="text" id="address-line2" />
      <label for="city">City:</label>
      <input type="text" id="city" />
      <label for="province">Province:</label>
      <input type="text" id="province" />
      <label for="postal-code">Postal Code:</label>
      <input type="text" id="postal-code" />
      <label for="telephone">Telephone:</label>
      <input type="text" id="telephone" />
      <label for="vat-number">VAT Number:</label>
      <input type="text" id="vat-number" />
      <button onclick="updateBusinessDetails()">Update</button>
    </div>
  </div>

  <script>
    // Tab switching logic
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".tab").forEach(tab => {
        tab.addEventListener("click", () => {
          document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
          document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
          tab.classList.add("active");
          document.getElementById(tab.dataset.tab).classList.add("active");
        });
      });

      // Fetch and populate data for all tabs
      fetchUsers();
      fetchRequesters();
      fetchItems();
      fetchProjects();
      fetchSettings();
      fetchBusinessDetails();
    });

    async function fetchUsers() {
      try {
        const res = await fetch("/lookups/users");
        const data = await res.json();
        const tbody = document.getElementById("users-table");
        tbody.innerHTML = "";
        data.users.forEach(user => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${user.username}</td>
            <td>${user.rights}</td>
            <td><button onclick="deleteUser(${user.id})">Delete</td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error("Failed to fetch users:", err);
      }
    }

    async function addUser() {
      const username = document.getElementById("user-username").value;
      const password = document.getElementById("user-password").value;
      const rights = document.getElementById("user-rights").value;
      try {
        const res = await fetch("/lookups/users", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password, rights })
        });
        if (res.ok) fetchUsers();
      } catch (err) {
        console.error("Failed to add user:", err);
      }
    }

    async function deleteUser(id) {
      try {
        const res = await fetch(`/lookups/users/${id}`, { method: "DELETE" });
        if (res.ok) fetchUsers();
      } catch (err) {
        console.error("Failed to delete user:", err);
      }
    }

    async function fetchRequesters() {
      try {
        const res = await fetch("/lookups/requesters");
        const data = await res.json();
        const tbody = document.getElementById("requesters-table");
        tbody.innerHTML = "";
        data.requesters.forEach(requester => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${requester.name}</td>
            <td><button onclick="deleteRequester(${requester.id})">Delete</td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error("Failed to fetch requesters:", err);
      }
    }

    async function addRequester() {
      const name = document.getElementById("requester-name").value;
      try {
        const res = await fetch("/lookups/requesters", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name })
        });
        if (res.ok) fetchRequesters();
      } catch (err) {
        console.error("Failed to add requester:", err);
      }
    }

    async function deleteRequester(id) {
      try {
        const res = await fetch(`/lookups/requesters/${id}`, { method: "DELETE" });
        if (res.ok) fetchRequesters();
      } catch (err) {
        console.error("Failed to delete requester:", err);
      }
    }

    async function fetchItems() {
      try {
        const res = await fetch("/lookups/items");
        const data = await res.json();
        const tbody = document.getElementById("items-table");
        tbody.innerHTML = "";
        data.items.forEach(item => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.item_code}</td>
            <td>${item.item_description}</td>
            <td><button onclick="deleteItem(${item.id})">Delete</td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error("Failed to fetch items:", err);
      }
    }

    async function addItem() {
      const item_code = document.getElementById("item-code").value;
      const item_description = document.getElementById("item-description").value;
      try {
        const res = await fetch("/lookups/items", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ item_code, item_description })
        });
        if (res.ok) fetchItems();
      } catch (err) {
        console.error("Failed to add item:", err);
      }
    }

    async function deleteItem(id) {
      try {
        const res = await fetch(`/lookups/items/${id}`, { method: "DELETE" });
        if (res.ok) fetchItems();
      } catch (err) {
        console.error("Failed to delete item:", err);
      }
    }

    async function fetchProjects() {
      try {
        const res = await fetch("/lookups/projects");
        const data = await res.json();
        const tbody = document.getElementById("projects-table");
        tbody.innerHTML = "";
        data.projects.forEach(project => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${project.project_code}</td>
            <td>${project.project_name}</td>
            <td><button onclick="deleteProject(${project.id})">Delete</td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error("Failed to fetch projects:", err);
      }
    }

    async function addProject() {
      const project_code = document.getElementById("project-code").value;
      const project_name = document.getElementById("project-name").value;
      try {
        const res = await fetch("/lookups/projects", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ project_code, project_name })
        });
        if (res.ok) fetchProjects();
      } catch (err) {
        console.error("Failed to add project:", err);
      }
    }

    async function deleteProject(id) {
      try {
        const res = await fetch(`/lookups/projects/${id}`, { method: "DELETE" });
        if (res.ok) fetchProjects();
      } catch (err) {
        console.error("Failed to delete project:", err);
      }
    }

    async function fetchSettings() {
      try {
        const res = await fetch("/lookups/settings");
        const data = await res.json();
        document.getElementById("order-number-start").value = data.order_number_start || "";
        document.getElementById("auth-threshold").value = data.auth_threshold || "";
      } catch (err) {
        console.error("Failed to fetch settings:", err);
      }
    }

    async function updateSettings() {
      const order_number_start = document.getElementById("order-number-start").value;
      const auth_threshold = document.getElementById("auth-threshold").value;
      try {
        const res = await fetch("/lookups/settings", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ order_number_start, auth_threshold })
        });
        if (res.ok) fetchSettings();
      } catch (err) {
        console.error("Failed to update settings:", err);
      }
    }

    async function fetchBusinessDetails() {
      try {
        const res = await fetch("/lookups/business_details");
        const data = await res.json();
        document.getElementById("company-name").value = data.company_name || "";
        document.getElementById("address-line1").value = data.address_line1 || "";
        document.getElementById("address-line2").value = data.address_line2 || "";
        document.getElementById("city").value = data.city || "";
        document.getElementById("province").value = data.province || "";
        document.getElementById("postal-code").value = data.postal_code || "";
        document.getElementById("telephone").value = data.telephone || "";
        document.getElementById("vat-number").value = data.vat_number || "";
      } catch (err) {
        console.error("Failed to fetch business details:", err);
      }
    }

    async function updateBusinessDetails() {
      const company_name = document.getElementById("company-name").value;
      const address_line1 = document.getElementById("address-line1").value;
      const address_line2 = document.getElementById("address-line2").value;
      const city = document.getElementById("city").value;
      const province = document.getElementById("province").value;
      const postal_code = document.getElementById("postal-code").value;
      const telephone = document.getElementById("telephone").value;
      const vat_number = document.getElementById("vat-number").value;
      try {
        const res = await fetch("/lookups/business_details", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            company_name, address_line1, address_line2, city,
            province, postal_code, telephone, vat_number
          })
        });
        if (res.ok) fetchBusinessDetails();
      } catch (err) {
        console.error("Failed to update business details:", err);
      }
    }
  </script>

</body>
</html>