<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Order</title>
    <link rel="stylesheet" href="/static/css/new_order.css">
</head>
<body>
    <div class="container">
        <h2>Create Purchase Order</h2>
        <div class="header-section">
            <div>
                <label for="supplier_id">Supplier *</label>
                <select id="supplier_id" name="supplier_id">
                    <option value="">Select Supplier</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                    {% endfor %}
                </select>
                <label for="note_to_supplier">Note to Supplier</label>
                <textarea id="note_to_supplier" name="note_to_supplier" rows="3"></textarea>
            </div>
            <div>
                <label>Delivery Address</label>
                <div class="address-box">
                    Universal Recycling Company Pty Ltd<br>
                    [Address Line 1 from DB]<br>
                    [Address Line 2 from DB]<br>
                    [City, Province, Area Code from DB]<br>
                    Telephone: [Telephone from DB]<br>
                    VAT Number: [VAT Number from DB]
                </div>
            </div>
        </div>

        <table id="items-table">
            <thead>
                <tr>
                    <th>Item Code</th>
                    <th>Description</th>
                    <th>Project</th>
                    <th>Qty Ordered</th>
                    <th>Price (R)</th>
                    <th>Total (R)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><input type="text" name="items[0][item_code]"></td>
                    <td><input type="text" name="items[0][item_description]"></td>
                    <td><input type="text" name="items[0][project]"></td>
                    <td><input type="number" name="items[0][qty_ordered]" step="1" min="1" value="1" onchange="updateTotal(0)"></td>
                    <td><input type="number" name="items[0][price]" step="0.01" min="0" value="0" onchange="updateTotal(0)"></td>
                    <td><input type="text" name="items[0][total]" readonly></td>
                    <td><button type="button" onclick="removeRow(this)">Remove</button></td>
                </tr>
            </tbody>
        </table>
        <button type="button" onclick="addRow()">Add Item</button>

        <div class="total-section">
            <label>Total: R <span id="grand-total">0.00</span></label>
            <div class="vat-note">Excluding VAT</div>
        </div>

        <div class="button-section">
            <button type="button" id="email-po" onclick="emailPurchaseOrder()">Email Purchase Order</button>
            <button type="submit" onclick="submitForm()">Submit Order</button>
            <button type="button" id="view-po" onclick="viewPurchaseOrder()">View Purchase Order</button>
            <button type="button" onclick="cancelForm()">Cancel</button>
        </div>
    </div>

    <script>
        (function () {
            let rowCount = 1;

            function addRow() {
                const tbody = document.querySelector("#items-table tbody");
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td><input type="text" name="items[${rowCount}][item_code]"></td>
                    <td><input type="text" name="items[${rowCount}][item_description]"></td>
                    <td><input type="text" name="items[${rowCount}][project]"></td>
                    <td><input type="number" name="items[${rowCount}][qty_ordered]" step="1" min="1" value="1" onchange="updateTotal(${rowCount})"></td>
                    <td><input type="number" name="items[${rowCount}][price]" step="0.01" min="0" value="0" onchange="updateTotal(${rowCount})"></td>
                    <td><input type="text" name="items[${rowCount}][total]" readonly></td>
                    <td><button type="button" onclick="removeRow(this)">Remove</button></td>
                `;
                tbody.appendChild(row);
                rowCount++;
                updateGrandTotal();
            }

            function removeRow(button) {
                if (rowCount > 1) {
                    button.parentElement.parentElement.remove();
                    rowCount--;
                    updateGrandTotal();
                }
            }

            function updateTotal(index) {
                const qty = parseFloat(document.querySelector(`input[name='items[${index}][qty_ordered]']`).value) || 0;
                const price = parseFloat(document.querySelector(`input[name='items[${index}][price]']`).value) || 0;
                const total = qty * price;
                document.querySelector(`input[name='items[${index}][total]']`).value = total.toFixed(2);
                updateGrandTotal();
            }

            function updateGrandTotal() {
                let grandTotal = 0;
                for (let i = 0; i < rowCount; i++) {
                    const totalField = document.querySelector(`input[name='items[${i}][total]']`);
                    if (totalField) {
                        grandTotal += parseFloat(totalField.value) || 0;
                    }
                }
                document.getElementById("grand-total").textContent = grandTotal.toFixed(2);
            }

            async function submitForm() {
                const formData = new FormData();
                const supplierId = document.getElementById("supplier_id").value;
                const noteToSupplier = document.getElementById("note_to_supplier").value;
                formData.append("supplier_id", supplierId);
                formData.append("note_to_supplier", noteToSupplier);
                formData.append("requester_id", "1"); // Hardcoded for demo; adjust as needed

                const items = [];
                for (let i = 0; i < rowCount; i++) {
                    const itemCode = document.querySelector(`input[name='items[${i}][item_code]']`)?.value;
                    const itemDescription = document.querySelector(`input[name='items[${i}][item_description]']`)?.value;
                    const project = document.querySelector(`input[name='items[${i}][project]']`)?.value;
                    const qtyOrdered = document.querySelector(`input[name='items[${i}][qty_ordered]']`)?.value;
                    const price = document.querySelector(`input[name='items[${i}][price]']`)?.value;
                    if (itemCode && itemDescription && project && qtyOrdered && price) {
                        items.push({
                            item_code: itemCode,
                            item_description: itemDescription,
                            project: project,
                            qty_ordered: parseFloat(qtyOrdered),
                            price: parseFloat(price)
                        });
                    }
                }
                formData.append("items", JSON.stringify(items));

                const response = await fetch("/orders", {
                    method: "POST",
                    body: formData
                });
                const result = await response.json();
                if (response.ok) {
                    alert(`Order created successfully: ${result.order.order_number}`);
                    window.location.href = "/orders/pending";
                } else {
                    alert(`Failed to create order: ${result.detail}`);
                }
            }

            function emailPurchaseOrder() {
                alert("Email Purchase Order functionality will be implemented after fixing PDF generation.");
                // Placeholder for emailing the PDF; to be implemented later
            }

            function viewPurchaseOrder() {
                alert("View Purchase Order functionality will be implemented after fixing PDF generation.");
                // Placeholder; to be linked to the view order screen after fixing PDF
                window.location.href = "/orders/pending"; // Temporary redirect
            }

            function cancelForm() {
                window.location.href = "/orders/pending";
            }

            // Expose functions to the global scope for onclick handlers
            window.addRow = addRow;
            window.removeRow = removeRow;
            window.updateTotal = updateTotal;
            window.submitForm = submitForm;
            window.emailPurchaseOrder = emailPurchaseOrder;
            window.viewPurchaseOrder = viewPurchaseOrder;
            window.cancelForm = cancelForm;
        })();
    </script>
</body>
</html>