<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Order</title>
    <link rel="icon" href="data:,">
    <style>
        body { font-family: Arial, sans-serif; padding: 2rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
        .status { font-weight: bold; }
        .filters { margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
        .filters label { font-weight: bold; }
        input[type="date"], select, textarea, input[type="number"], input[type="text"] {
            padding: 0.4rem;
            font-size: 1rem;
            font-family: monospace;
        }
        button {
            padding: 0.5rem 1rem;
            cursor: pointer;
            margin-top: 1rem;
            margin-right: 1rem;
        }
        label {
            display: block;
            font-weight: bold;
            margin-top: 1rem;
        }
    </style>
</head>
<body>

    <div>
        <h2>Create Purchase Order</h2>
        <div>
            <div>
                <label for="requester_id">Requester *</label>
                <select id="requester_id" name="requester_id">
                    <option value="">Select Requester</option>
                    {% for requester in requesters %}
                    <option value="{{ requester.id }}">{{ requester.name }}</option>
                    {% endfor %}
                </select>
                <label for="supplier_id">Supplier *</label>
                <select id="supplier_id" name="supplier_id">
                    <option value="">Select Supplier</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                    {% endfor %}
                </select>
                <label for="note_to_supplier">Note to Supplier</label>
                <textarea id="note_to_supplier" name="note_to_supplier" rows="3"></textarea>
            </div>
            <div>
                <label>Delivery Address</label>
                <div>
                    Universal Recycling Company Pty Ltd<br>
                    [Address Line 1 from DB]<br>
                    [Address Line 2 from DB]<br>
                    [City, Province, Area Code from DB]<br>
                    Telephone: [Telephone from DB]<br>
                    VAT Number: [VAT Number from DB]
                </div>
            </div>
        </div>

        <table id="items-table">
            <thead>
                <tr>
                    <th>Item Code</th>
                    <th>Description</th>
                    <th>Project</th>
                    <th>Qty Ordered</th>
                    <th>Price (R)</th>
                    <th>Total (R)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <select name="items[0][item_code]" id="item_code_0" onchange="updateItemDescription(0)">
                            <option value="">Select Item</option>
                            {% for item in items %}
                            <option value="{{ item.item_code }}" data-description="{{ item.item_description }}">{{ item.item_code }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td><input type="text" name="items[0][item_description]" id="item_description_0" readonly></td>
                    <td>
                        <select name="items[0][project]" id="project_0">
                            <option value="">Select Project</option>
                            {% for project in projects %}
                            <option value="{{ project.project_code }}">{{ project.project_code }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td><input type="number" name="items[0][qty_ordered]" id="qty_ordered_0" step="1" min="1" value="1" onchange="updateTotal(0)"></td>
                    <td><input type="number" name="items[0][price]" id="price_0" step="0.01" min="0" value="0" onchange="updateTotal(0)"></td>
                    <td><input type="text" name="items[0][total]" id="total_0" readonly></td>
                    <td><button type="button" onclick="removeRow(this)">Remove</button></td>
                </tr>
            </tbody>
        </table>
        <button type="button" onclick="addRow()">Add Item</button>

        <div>
            <label>Total: R <span id="grand-total">0.00</span></label>
            <div>Excluding VAT</div>
        </div>

        <div>
            <button type="button" id="view-po" onclick="viewPurchaseOrder()">View Purchase Order</button>
            <button type="button" id="email-po" onclick="emailPurchaseOrder()">Email Purchase Order</button>
            <button type="submit" onclick="submitForm()">Submit Order</button>
            <button type="button" onclick="cancelForm()">Cancel</button>
        </div>
    </div>

    <script>
        console.log("Requesters data:", {{ requesters | tojson }});
        console.log("Suppliers data:", {{ suppliers | tojson }});

        let rowCount = 1;

        window.addEventListener('load', function() {
            console.log("Page loaded");
            console.log("Requester dropdown options:", document.getElementById('requester_id').options.length);
            console.log("Supplier dropdown options:", document.getElementById('supplier_id').options.length);
        });

        function addRow() {
            console.log("Adding new row, rowCount:", rowCount);
            const tbody = document.querySelector("#items-table tbody");
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>
                    <select name="items[${rowCount}][item_code]" id="item_code_${rowCount}" onchange="updateItemDescription(${rowCount})">
                        <option value="">Select Item</option>
                        {% for item in items %}
                        <option value="{{ item.item_code }}" data-description="{{ item.item_description }}">{{ item.item_code }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td><input type="text" name="items[${rowCount}][item_description]" id="item_description_${rowCount}" readonly></td>
                <td>
                    <select name="items[${rowCount}][project]" id="project_${rowCount}">
                        <option value="">Select Project</option>
                        {% for project in projects %}
                        <option value="{{ project.project_code }}">{{ project.project_code }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td><input type="number" name="items[${rowCount}][qty_ordered]" id="qty_ordered_${rowCount}" step="1" min="1" value="1" onchange="updateTotal(${rowCount})"></td>
                <td><input type="number" name="items[${rowCount}][price]" id="price_${rowCount}" step="0.01" min="0" value="0" onchange="updateTotal(${rowCount})"></td>
                <td><input type="text" name="items[${rowCount}][total]" id="total_${rowCount}" readonly></td>
                <td><button type="button" onclick="removeRow(this)">Remove</button></td>
            `;
            tbody.appendChild(row);
            rowCount++;
            updateGrandTotal();
        }

        function removeRow(button) {
            if (rowCount > 1) {
                console.log("Removing row, rowCount before:", rowCount);
                button.parentElement.parentElement.remove();
                rowCount--;
                console.log("Row removed, rowCount after:", rowCount);
                updateGrandTotal();
            }
        }

        function updateItemDescription(index) {
            console.log("Updating item description for index:", index);
            const select = document.getElementById(`item_code_${index}`);
            const descriptionInput = document.getElementById(`item_description_${index}`);
            const selectedOption = select.options[select.selectedIndex];
            descriptionInput.value = selectedOption.getAttribute("data-description") || "";
            updateTotal(index);
        }

        function updateTotal(index) {
            console.log("Updating total for index:", index);
            const qty = parseFloat(document.getElementById(`qty_ordered_${index}`).value) || 0;
            const price = parseFloat(document.getElementById(`price_${index}`).value) || 0;
            const total = qty * price;
            document.getElementById(`total_${index}`).value = total.toFixed(2);
            updateGrandTotal();
        }

        function updateGrandTotal() {
            console.log("Updating grand total");
            let grandTotal = 0;
            for (let i = 0; i < rowCount; i++) {
                const totalField = document.getElementById(`total_${i}`);
                if (totalField) {
                    grandTotal += parseFloat(totalField.value) || 0;
                }
            }
            document.getElementById("grand-total").textContent = grandTotal.toFixed(2);
        }

        async function submitForm() {
            console.log("submitForm started");

            const supplierId = document.getElementById("supplier_id").value;
            console.log("Supplier ID:", supplierId);
            const requesterId = document.getElementById("requester_id").value;
            console.log("Requester ID:", requesterId);
            const noteToSupplier = document.getElementById("note_to_supplier").value;
            console.log("Note to Supplier:", noteToSupplier);

            const items = [];
            for (let i = 0; i < rowCount; i++) {
                const itemCode = document.getElementById(`item_code_${i}`)?.value;
                const itemDescription = document.getElementById(`item_description_${i}`)?.value;
                const project = document.getElementById(`project_${i}`)?.value;
                const qtyOrdered = document.getElementById(`qty_ordered_${i}`)?.value;
                const price = document.getElementById(`price_${i}`)?.value;
                if (itemCode && itemDescription && project && qtyOrdered && price) {
                    const item = {
                        item_code: itemCode,
                        item_description: itemDescription,
                        project: project,
                        qty_ordered: parseFloat(qtyOrdered),
                        price: parseFloat(price)
                    };
                    items.push(item);
                }
            }
            console.log("Items collected:", items);

            // Validation
            if (!supplierId) {
                console.log("Validation failed: No supplier selected");
                alert("Please select a supplier.");
                return;
            }
            if (!requesterId) {
                console.log("Validation failed: No requester selected");
                alert("Please select a requester.");
                return;
            }
            if (items.length === 0) {
                console.log("Validation failed: No items added");
                alert("Please add at least one item with all required fields.");
                return;
            }

            // Create JSON payload
            const payload = {
                supplier_id: parseInt(supplierId),
                requester_id: parseInt(requesterId),
                note_to_supplier: noteToSupplier,
                items: items
            };
            console.log("Submitting order with JSON data:", payload);

            // Send JSON request
            try {
                const response = await fetch("/orders", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });
                console.log("Response received, status:", response.status);

                const result = await response.json();
                console.log("Response JSON:", result);

                if (response.ok) {
                    console.log("Order created successfully");
                    alert(`Order created successfully: ${result.order.order_number}`);
                    window.location.href = "/orders/pending";
                } else {
                    console.log("Failed to create order, details:", result.detail);
                    alert("Failed to create order: " + (typeof result.detail === 'string' ? result.detail : JSON.stringify(result.detail)));
                }
            } catch (error) {
                console.error("Error during fetch:", error);
                alert("An error occurred while submitting the order: " + error.message);
            }
        }

        function emailPurchaseOrder() {
            console.log("Email Purchase Order clicked");
            alert("Email Purchase Order functionality will be implemented after fixing PDF generation.");
        }

        function viewPurchaseOrder() {
            console.log("View Purchase Order clicked");
            alert("View Purchase Order functionality will be implemented after fixing PDF generation.");
            window.location.href = "/orders/pending";
        }

        function cancelForm() {
            console.log("Cancel button clicked");
            window.location.href = "/orders/pending";
        }

        window.addRow = addRow;
        window.removeRow = removeRow;
        window.updateItemDescription = updateItemDescription;
        window.updateTotal = updateTotal;
        window.submitForm = submitForm;
        window.emailPurchaseOrder = emailPurchaseOrder;
        window.viewPurchaseOrder = viewPurchaseOrder;
        window.cancelForm = cancelForm;
    </script>
</body>
</html>